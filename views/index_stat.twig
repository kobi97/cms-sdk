{% extends 'index_new.twig' %}
{% block title %}
  {{ title }}
{% endblock %}

{% block script %}
  <script type="text/javascript">
    require(['jquery', 'stickyTableHeaders'], function ($) {
      $('.js-sticky-table-header').stickyTableHeaders();
      function exportTableToCSV($table, filename) {
        //http://stackoverflow.com/questions/15423870/find-next-table-when-click-in-a-div
        // Temporary delimiter characters unlikely to be typed by keyboard
        // This is to avoid accidentally splitting the actual contents
        var $rows = $table.find('tr:has(td)'),
          tmpColDelim = String.fromCharCode(11), // vertical tab character
          tmpRowDelim = String.fromCharCode(0), // null character

          colDelim = '</td><td>',
          rowDelim = '</td></tr><tr><td>',

        // Grab text from table into CSV formatted string
          csv = '<table><tr><td>' + $rows.map(function (i, row) {
              var $row = $(row),
                $cols = $row.find('td');

              return $cols.map(function (j, col) {
                var $col = $(col),
                  text = $col.text();

                return text.replace('"', '""'); // escape double quotes

              }).get().join(tmpColDelim);

            }).get().join(tmpRowDelim)
              .split(tmpRowDelim).join(rowDelim)
              .split(tmpColDelim).join(colDelim) + '</td></tr></table>',

        // Data URI
          xlsData = 'data:application/xls;charset=utf-8,' + encodeURIComponent(csv);

        $(this)
          .attr({
            'download': filename,
            'href': xlsData,
            'target': '_blank'
          });
      }

      // This must be a hyperlink
      $(".js_export").on('click', function (event) {
        exportTableToCSV.apply(this, [$(this).parent().parent().find('table'), 'export.xls']);
      });
    })
  </script>

{% endblock %}

{% block body %}

  {% for table_name, table in tables %}
    {% if table |length %}
      <div>
        <h3>{{ table_name }}</h3>
        <p>{{ descriptions[table_name] }}</p>
        <table class="table table-striped table-bordered table-condensed js-sticky-table-header" datatable>
          <thead>
          <tr>
            {% for key, value in (table|first) %}
              <td style="background-color: white">
                {{ key }}
              </td>
            {% endfor %}
          </tr>
          </thead>
          <tbody>
          {% for row in table %}
            <tr>
              {% for key, value in (table|first) %}
                <td style="text-align: right">{{ row[key] }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
          </tbody>
        </table>
        <a href="#" class="js_export">엑셀받기</a>
        <sub style="float:right">{{ query_datetimes[table_name] }}</sub>
      </div>
    {% endif %}
  {% endfor %}

  <button class="btn" onclick="$('#querylog').toggle()">쿼리 보기</button>
  <div style="display:none" id="querylog">
    {% for query_name, querys in querylogs %}
      <div>
        <h2>{{ query_name }}</h2>
        {% for query in querys %}
          <pre>{{ query }}</pre>
        {% endfor %}
      </div>
    {% endfor %}
  </div>

{% endblock %}
